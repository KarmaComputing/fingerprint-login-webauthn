<!DOCTYPE html>

<html>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <h1>Webauthn Demo</h1>

  <div style="border: 2px solid red;">
    <p>This is a demo. The server side component is simulated client side.</p>
    <p>In relatity, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API#registration">the challenge <em>must</em> be sent by the server</a>.
  </div>

  <div id="output" style="border: 1px solid black;"></div>

  <p>There are two key stages with Webauthn:</p>

  <ol>
    <li><a href="https://www.w3.org/TR/webauthn-2/#sctn-usecase-registration" target="_blank">Registration</a></li>
    <li><a href="https://www.w3.org/TR/webauthn-2/#sctn-usecase-authentication" target="_blank">Authentication</a></li>
  </ol>


  <h2>Webauthn - Registration</h2>
  <p>
  On a phone:
  </p>

  <ol>
    <li>
  User navigates to example.com in a browser and signs in to an existing account using whatever method they have been using (possibly a legacy method such as a password), or creates a new account.
    </li>

    <li>
    The phone prompts, "Do you want to register this device with example.com?"
    </li>

    <li>
    User agrees.
    </li>

    <li>
    The phone prompts the user for a previously configured authorization gesture (PIN, biometric, etc.); the user provides this.
    </li>

    <li>
    Website shows message, "Registration complete."
    </li>
  </ol>

  <button id="authenticate">Authenticate/Login</button>
 
  <h3>1) Sign-in</h3>
    Demo: alice@example.com/secret
    <form id="sign-in">
      Email: <input type="email" name="email" placeholder="alice@example.com" /><br />
      Password: <input type="password" name="password" placeholder="secret" /><br />
      <input type="submit" />
    </form>

    <div id="do-you-want-to-register-your-device" style="display: none">
      <h3>2) Do you want to register this device with this site?</h3>
      <button id="register">Yes</button>
      <button>No</button>
      <br /><br /><br />
    </div>

<!-- Note: This code does not run from top to bottom -->
<!-- Note: Run from localhost (not 127.0.0.1) or a https address -->

<script>

// Sign in

signInForm = document.getElementById("sign-in");

signInForm.addEventListener("submit", function(e) {
  e.preventDefault();
  document.getElementById("do-you-want-to-register-your-device").style.display="block";
  window.scrollTo(0,document.body.scrollHeight);
})

// Register a user
document.getElementById("register").addEventListener('click', function(e) {
  // register / create a new credential
  const randomStringFromServer = "D\x96\xf4\xe9\x184{\x04j\xf5\xa4\x0f\xf7\xd0\x01Y\xf4\x98__Z\xf0\xab7\xeb\xa8\xc4E\xd6\x1d\xa9\x8c\x95B[\x0b4'\x97\x8a\x06\xe7\x1b\xd0\xa1@W\x186\x7fR\xa4\xcb\xdf{\x97m\xda\x89\xdciy\xd0\xac"

const publicKeyCrendentialCreationOptions = {
        "challenge": Uint8Array.from(
    randomStringFromServer, c => c.charCodeAt(0)),
        "rp": {
            "name": "Karma Computing",
            /* Id not required, and is OK to not provide
            since the challange includes the origin
            when generating the attestationObject
            */
            /*"id": "localhost" */
        },
        "user": {
            "name": "Bob",
            "displayName": "Bob",
            "id": Uint8Array.from(
      "UZSL85T9AFC", c => c.charCodeAt(0))
        },
        /* https://w3c.github.io/webauthn/#dom-publickeycredentialcreationoptions-pubkeycredparams */
        "pubKeyCredParams": [
            {
                "type": "public-key",
                "alg": -7
            },
            {
                "type": "public-key",
                "alg": -35
            },
            {
                "type": "public-key",
                "alg": -36
            },
            {
                "type": "public-key",
                "alg": -257
            },
            {
                "type": "public-key",
                "alg": -258
            },
            {
                "type": "public-key",
                "alg": -259
            },
            {
                "type": "public-key",
                "alg": -37
            },
            {
                "type": "public-key",
                "alg": -38
            },
            {
                "type": "public-key",
                "alg": -39
            },
            {
                "type": "public-key",
                "alg": -8
            }
        ],
        "authenticatorSelection": {A
            /* https://www.w3.org/TR/webauthn-2/#dom-authenticatorselectioncriteria-requireresidentkey */
            /* "requireResidentKey": false, */
            "userVerification": "preferred",
            "authenticatorAttachment": "platform"
        },
        "timeout": 60000,
        "attestation": "direct",
}

  createCredential(publicKeyCrendentialCreationOptions);
});


async function createCredential(publicKeyCrendentialCreationOptions) {
  log("in createCredential");
  
  const crendential = await navigator.credentials.create({
    publicKey: publicKeyCrendentialCreationOptions,
    UserVerificationRequirement: {}
  }).then((creds) => { log(creds)});
}
  

// Authenticate existing user
document.getElementById("authenticate").addEventListener('click', function(e) {
  navigator.credentials.get(getCredentialDefaultArgs).then((creds) => { console.log(creds)});
  // What happens next?
});





// sample arguments for login
var getCredentialDefaultArgs = {
    publicKey: {
        timeout: 60000,
        // allowCredentials: [newCredential] // see below
        challenge: new Uint8Array([ // must be a cryptographically random number sent from a server
            0x79, 0x50, 0x68, 0x71, 0xDA, 0xEE, 0xEE, 0xB9, 0x94, 0xC3, 0xC2, 0x15, 0x67, 0x65, 0x26, 0x22,
            0xE3, 0xF3, 0xAB, 0x3B, 0x78, 0x2E, 0xD5, 0x6F, 0x81, 0x26, 0xE2, 0xA6, 0x01, 0x7D, 0x74, 0x50
        ]).buffer
    },
};

function log(msg) {
  console.log(msg);
  document.getElementById("output").innerHTML += "<br />" + msg;
}


</script>
</html>
